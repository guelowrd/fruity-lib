use dep::std;

/////////////////////////////////
// 1. Private Set Intersection //
/////////////////////////////////

global MAX_ARRAY_SIZE_FOR_PSI: Field = 20;

// @dev Checks that the intersection of two private sets is non-empty.
// @param commitment_a A Pedersen hash of the first set of hashed elements serving as a public commitment to the first set.
// @param commitment_b A Pedersen hash of the second set of hashed elements serving as a public commitment to the second set.
// @param private_set_a First set of hashed elements (can be any hash function).
// @param private_set_b Second set of hashed elements (can be any hash function).
// @param intersection_is_empty A boolean indicating whether we want to check the intersection is empty or non-empty.
// @dev The function first checks that the commitments, then compute the cardinality of the intersection of the two sets, and finally asserts that this cardinality is empty or not (depending on intersection_is_empty input).
// @notice If you use the function in your project, make sure the commitments `pub_commitment_a` & `pub_commitment_b` and the emptyness to check `intersection_is_empty` are public inputs.
fn check_private_set_intersection(
    commitment_a: Field, 
    commitment_b: Field, 
    private_set_a: [Field; MAX_ARRAY_SIZE_FOR_PSI], 
    private_set_b: [Field; MAX_ARRAY_SIZE_FOR_PSI],
    intersection_is_empty: bool
) {
    check_commitment_of_private_set(commitment_a, private_set_a);
    check_commitment_of_private_set(commitment_b, private_set_b);
    let cardinality = get_intersection_cardinality(private_set_a, private_set_b);
    if intersection_is_empty {
        assert(cardinality == 0);
    } else {
        assert(cardinality != 0);
    }
}

fn get_max_array_size_for_psi() -> Field {
    MAX_ARRAY_SIZE_FOR_PSI
}

fn check_commitment_of_private_set(commitment: Field, set: [Field; MAX_ARRAY_SIZE_FOR_PSI]) {
    let computed_commitment = std::hash::pedersen(set);
    assert(commitment == computed_commitment[0]);
}

fn get_intersection_cardinality(private_set_a : [Field; MAX_ARRAY_SIZE_FOR_PSI], private_set_b : [Field; MAX_ARRAY_SIZE_FOR_PSI]) -> Field {
    let mut cardinality: Field = 0;
    for i in 0..MAX_ARRAY_SIZE_FOR_PSI {
        for j in 0..MAX_ARRAY_SIZE_FOR_PSI {
            // We only need to check that private_set_a[i] != 0, as if this condition holds then private_set_a[i] == private_set_b[j] implies that private_set_b[j] != 0.
            if (private_set_a[i] != 0) & (private_set_a[i] as u64 == private_set_b[j] as u64) {
                cardinality += 1;
            }
        }
    }
    cardinality
}

//////////////
// 2. Tests //
//////////////

#[test]
fn test_private_set_intersection_is_empty() {
    let private_set_a: [Field; MAX_ARRAY_SIZE_FOR_PSI] = [0xb74e2884bd845cc06bc0e2fc2841fc5015865ef7b84688dbcb700b84ac216c22,0x0000000000000000000000000000000000000000000000000000000000000000,0xf3d1edb7c28457ca230e195689fe4f735229f3c4e465e08467815e8bc56584a8,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000];
    let private_set_b: [Field; MAX_ARRAY_SIZE_FOR_PSI] = [0x0000000000000000000000000000000000000000000000000000000000000000,0xd1a76970243ed6fa98d5609955ebb75d21fa1e834afc6e72197392014a4f0fbc,0x1a5203a4da0667310353cb45e76f30f733bb2789487f8fdf11f68edd057b5e19,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000];   
    let pub_commitment_a: Field = 0x16ad1d69b4502e3285c21a34da7c3b3cade1307aa22b62218eb01b38b51eebce;
    let pub_commitment_b: Field = 0x18398d61bdfc65f29b57346e3ef7c78b7637ee5a50e62cd5506b0df42c9ef8e7;
    let intersection_is_empty: bool = true;
    check_private_set_intersection(pub_commitment_a, pub_commitment_b, private_set_a, private_set_b, intersection_is_empty);
}

#[test]
fn test_private_set_intersection_is_not_empty() {
    let pub_commitment_a: Field = 0x26ed5e1af87ec150f8f69345f4b4db8ae49fea36516f72403ed590fa1bfe3570;
    let pub_commitment_b: Field = 0x0f3fc7cbde26e9f4972e074591a3aa2e3e125e71285aad8174bd73aeb0876d5f;
    let private_set_a: [Field; MAX_ARRAY_SIZE_FOR_PSI] = [0xb74e2884bd845cc06bc0e2fc2841fc5015865ef7b84688dbcb700b84ac216c22,0xd5bc4f28142b87c37b07862dd864ca3923a16ce9a72597297bed636d7e127851,0xf3d1edb7c28457ca230e195689fe4f735229f3c4e465e08467815e8bc56584a8,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000];
    let private_set_b: [Field; MAX_ARRAY_SIZE_FOR_PSI] = [0xd5bc4f28142b87c37b07862dd864ca3923a16ce9a72597297bed636d7e127851,0xd1a76970243ed6fa98d5609955ebb75d21fa1e834afc6e72197392014a4f0fbc,0x1a5203a4da0667310353cb45e76f30f733bb2789487f8fdf11f68edd057b5e19,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000];   
    let intersection_is_empty: bool = false;
    check_private_set_intersection(pub_commitment_a, pub_commitment_b, private_set_a, private_set_b, intersection_is_empty);
}

#[test]
fn test_get_max_array_size_for_psi() {
    let expected_max_array_size_for_psi: Field = 20;
    let actual_max_array_size_for_psi: Field = get_max_array_size_for_psi();
    assert(expected_max_array_size_for_psi == actual_max_array_size_for_psi);
}
